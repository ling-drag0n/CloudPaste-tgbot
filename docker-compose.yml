version: "3.8"

services:
  tg-botapi-proxy:
    # 同时启动 telegram-bot-api(--local) + 代理(FastAPI)
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tg-botapi-proxy
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "${PORT:-7860}:7860"
    volumes:
      # 持久化目录：容器重启后文件缓存不丢，避免 404
      - tg_bot_api_data:/var/lib/telegram-bot-api
    environment:
      # - start.sh 会用 TELEGRAM_WORK_DIR 作为 telegram-bot-api 的 --dir
      # - BOT_TOKEN 在代理层的 URL 里会用到（/tg/bot<TOKEN>/...）
      TELEGRAM_WORK_DIR: "${TELEGRAM_WORK_DIR:-/var/lib/telegram-bot-api}"
      TELEGRAM_TEMP_DIR: "${TELEGRAM_TEMP_DIR:-/tmp/telegram-bot-api-tmp}"

      TELEGRAM_API_ID: "${TELEGRAM_API_ID}"
      TELEGRAM_API_HASH: "${TELEGRAM_API_HASH}"

      PORT: "${PORT:-7860}"
      TELEGRAM_PROXY_PREFIX: "${TELEGRAM_PROXY_PREFIX:-/tg}"
      TELEGRAM_UPSTREAM_PORT: "${TELEGRAM_UPSTREAM_PORT:-8081}"

      BOT_TOKEN: "${BOT_TOKEN}"

      TELEGRAM_VERBOSITY: "${TELEGRAM_VERBOSITY:-1}"
      TELEGRAM_DOWNLOAD_WAIT_SECONDS: "${TELEGRAM_DOWNLOAD_WAIT_SECONDS:-8}"
      TELEGRAM_DOWNLOAD_POLL_INTERVAL_MS: "${TELEGRAM_DOWNLOAD_POLL_INTERVAL_MS:-200}"

volumes:
  tg_bot_api_data:
